#!/usr/bin/env node
import fs from 'fs';
import path from 'path';
import chokidar from 'chokidar';
import {fileURLToPath} from 'url';
import {transpile} from '../src/transpile.js';
import {execSync} from 'child_process';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const args = process.argv.slice(2);
const command = args[0];

function runFile(filePath) {
	const code = fs.readFileSync(filePath, 'utf-8');
	const jsCode = transpile(code);
	console.log('--- Ð¢Ñ€Ð°Ð½ÑÐ¿Ð°Ð¹Ð»ÐµÐ½Ð¸Ð¹ ÐºÐ¾Ð´ ---\n');
	console.log(jsCode);
	console.log('\n--- Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ ---\n');
	eval(jsCode);
}

function buildProject() {
	const srcDir = path.resolve('src');
	const distDir = path.resolve('dist');
	fs.mkdirSync(distDir, {recursive: true});

	const files = fs.readdirSync(srcDir).filter(f => f.endsWith('.mowa'));
	for (const file of files) {
		const code = fs.readFileSync(path.join(srcDir, file), 'utf-8');
		const js = transpile(code);
		const outputName = file.replace(/\.mowa$/, '.js');
		fs.writeFileSync(path.join(distDir, outputName), js);
		console.log(`âœ… Ð—Ñ–Ð±Ñ€Ð°Ð½Ð¾: ${file} â†’ ${outputName}`);
	}
}

// ---INIT---
function initProject(target = '.') {
	const templateDir = path.join(__dirname, '../templates');
	const destDir = path.resolve(target);

	if (!fs.existsSync(destDir)) {
		fs.mkdirSync(destDir, {recursive: true});
		console.log(`ðŸ“ Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ Ð¿Ð°Ð¿ÐºÑƒ "${target}"`);
	}

	// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° package.json
	const userPkgPath = path.join(destDir, 'package.json');
	const templatePkgPath = path.join(templateDir, 'package.json');
	let userPackage = {};

	if (fs.existsSync(userPkgPath)) {
		userPackage = JSON.parse(fs.readFileSync(userPkgPath, 'utf-8'));
	}

	const templatePackage = fs.existsSync(templatePkgPath)
		? JSON.parse(fs.readFileSync(templatePkgPath, 'utf-8'))
		: {};

	userPackage.name = userPackage.name || templatePackage.name || 'mowa app';
	userPackage.version = userPackage.version || '1.0.0';
	userPackage.type = 'module';

	userPackage.scripts = {
		...templatePackage.scripts,
		...userPackage.scripts // Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ð¸Ð¼ÐµÑŽÑ‚ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚
	};


	userPackage.dependencies = {
		...templatePackage.dependencies,
		...userPackage.dependencies
	};

	userPackage.devDependencies = {
		...templatePackage.devDependencies,
		...userPackage.devDependencies
	};

	const deps = userPackage.dependencies;
	if (!deps['mowascript']) {
		deps['mowascript'] = templatePackage.dependencies?.['mowascript'] || '^1.0.0';
	}

	fs.writeFileSync(userPkgPath, JSON.stringify(userPackage, null, 2), 'utf-8');
	console.log('ðŸ§© ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð°Ð±Ð¾ ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ package.json');

	// ÐšÐ¾Ð¿Ñ–ÑŽÑ”Ð¼Ð¾ Ñ–Ð½ÑˆÑ– Ñ„Ð°Ð¹Ð»Ð¸, ÐºÑ€Ñ–Ð¼ package.json
	fs.readdirSync(templateDir).forEach(file => {
		if (file === 'package.json') return;
		const src = path.join(templateDir, file);
		const dest = path.join(destDir, file);
		fs.cpSync(src, dest, {recursive: true});
	});

	console.log(`âœ… Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð¿Ñ€Ð¾Ñ”ÐºÑ‚Ñƒ Ð² "${target}"`);
	console.log('âž¡ Ð”Ð°Ð»Ñ– Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸:');
	console.log(`   cd ${target}`);
	console.log('   npm install');
	console.log('   npm run build');
	console.log('   npm start');
}

// ---WATCH---
function watchProject() {
	const srcDir = path.resolve('src');
	const distDir = path.resolve('dist');

	fs.mkdirSync(distDir, { recursive: true });

	console.log('ðŸ‘€ Ð¡Ð»Ñ–Ð´ÐºÑƒÑŽ Ð·Ð° Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ñƒ src/ ...');

	console.log(srcDir);
	const watcher = chokidar.watch('src/**/*.mowa', {
		ignoreInitial: false,
		persistent: true,
	});

	// console.log(watcher)
	function transpileFile(file) {
		console.log('TTTTTTT');
		const relativePath = path.relative(srcDir, file);
		const outputPath = path.join(distDir, relativePath.replace(/\.mowa$/, '.js'));
		console.log(`ðŸ”„ ÐžÐ±Ñ€Ð¾Ð±ÐºÐ° Ñ„Ð°Ð¹Ð»Ñƒ: ${relativePath}`);

		try {
			const code = fs.readFileSync(file, 'utf-8');
			const js = transpile(code);
			fs.mkdirSync(path.dirname(outputPath), { recursive: true });
			fs.writeFileSync(outputPath, js);
			console.log(`âœ… ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð¾: ${relativePath}`);
		} catch (err) {
			console.error(`âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ñƒ Ñ„Ð°Ð¹Ð»Ñ– ${relativePath}:`, err.message);
		}
	}

	watcher.on('add', transpileFile);
	watcher.on('change', transpileFile);
	watcher.on('unlink', file => {
		const relativePath = path.relative(srcDir, file);
		const outputPath = path.join(distDir, relativePath.replace(/\.mowa$/, '.js'));
		if (fs.existsSync(outputPath)) {
			fs.unlinkSync(outputPath);
			console.log(`ðŸ—‘ Ð’Ð¸Ð´Ð°Ð»ÐµÐ½Ð¾: ${relativePath}`);
		}
	});
}

switch (command) {
	case 'run':
		runFile(args[1]);
		break;
	case 'build':
		buildProject();
		break;
	case 'init':
		initProject(args[1]);
		break;
	case 'watch':
		watchProject();
		break;
	default:
		console.log('ÐšÐ¾Ð¼Ð°Ð½Ð´Ð¸: init | build | run <Ñ„Ð°Ð¹Ð»>');
}
